<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/app :: page('Аналитика · Banking', ${active}, ~{::content})}">

<th:block th:fragment="content">

    <div class="card" style="margin-bottom:14px;">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;">
            <div>
                <h2 style="margin:0;">Аналитика</h2>
                <div class="muted">Сводные показатели и графики по заявкам/договорам/платежам.</div>
            </div>
        </div>
    </div>

    <div class="card" style="margin-bottom:14px;">
        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
            <div class="muted">Группировка:</div>

            <a class="btn" th:classappend="${period=='DAY'?' primary':''}"
               th:href="@{/reports(period='DAY')}">Дни</a>

            <a class="btn" th:classappend="${period=='MONTH'?' primary':''}"
               th:href="@{/reports(period='MONTH')}">Месяцы</a>

            <a class="btn" th:classappend="${period=='QUARTER'?' primary':''}"
               th:href="@{/reports(period='QUARTER')}">Кварталы</a>

            <a class="btn" th:classappend="${period=='YEAR'?' primary':''}"
               th:href="@{/reports(period='YEAR')}">Годы</a>
        </div>
    </div>

    <!-- KPI -->
    <div class="grid" style="grid-template-columns: repeat(3, minmax(0, 1fr)); margin-bottom:14px;">
        <div class="card">
            <div class="muted">Заявок всего</div>
            <div style="font-size:28px; font-weight:800;" id="kpiAppsTotal">—</div>
            <div class="muted" id="kpiAppsBreakdown">—</div>
        </div>

        <div class="card">
            <div class="muted">Договоров</div>
            <div style="font-size:28px; font-weight:800;" id="kpiContractsTotal">—</div>
            <div class="muted">Создано из одобренных заявок</div>
        </div>

        <div class="card">
            <div class="muted">Оплачено всего</div>
            <div style="font-size:28px; font-weight:800;" id="kpiPaidTotal">—</div>
            <div class="muted">По фактическим платежам</div>
        </div>
    </div>

    <!-- Charts -->
    <div class="grid" style="grid-template-columns: 1fr 1fr;">
        <div class="card">
            <!-- было "по месяцам" -->
            <div style="font-weight:700; margin-bottom:10px;">Платежи по периодам</div>
            <canvas id="chartPaidByMonth" height="140"></canvas>
        </div>

        <div class="card">
            <!-- было "по месяцам" -->
            <div style="font-weight:700; margin-bottom:10px;">Заявки по периодам</div>
            <canvas id="chartAppsByMonth" height="140"></canvas>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- ✅ период из thymeleaf в JS -->
    <script th:inline="javascript">
        const PERIOD = /*[[${period}]]*/ 'MONTH';
    </script>

    <script>
        function fmtMoney(v) {
          try {
            return Number(v).toLocaleString('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
          } catch(e) {
            return v;
          }
        }

        // ✅ прокидываем period
        fetch('/reports/dashboard-data?period=' + encodeURIComponent(PERIOD))
          .then(r => r.json())
          .then(data => {
            // KPI
            const kpi = data.kpi || {};
            document.getElementById('kpiAppsTotal').textContent = kpi.appsTotal != null ? kpi.appsTotal : '—';
            document.getElementById('kpiAppsBreakdown').textContent =
              'NEW: ' + (kpi.appsNew || 0) + ' · APPROVED: ' + (kpi.appsApproved || 0) + ' · REJECTED: ' + (kpi.appsRejected || 0);

            document.getElementById('kpiContractsTotal').textContent = kpi.contractsTotal != null ? kpi.contractsTotal : '—';
            document.getElementById('kpiPaidTotal').textContent = kpi.paidTotal != null ? fmtMoney(kpi.paidTotal) : '—';

            // Paid series (совместимость: контроллер отдаёт paidByMonth как алиас)
            const paid = data.paidByMonth || data.paidSeries || { labels: [], values: [] };
            new Chart(document.getElementById('chartPaidByMonth'), {
              type: 'bar',
              data: {
                labels: paid.labels,
                datasets: [{ label: 'Оплачено', data: paid.values }]
              },
              options: {
                responsive: true,
                plugins: { legend: { display: false } }
              }
            });

            // Apps series
            const apps = data.appsByMonth || data.appsSeries || { labels: [], values: [] };
            new Chart(document.getElementById('chartAppsByMonth'), {
              type: 'line',
              data: {
                labels: apps.labels,
                datasets: [{ label: 'Заявки', data: apps.values, tension: 0.25 }]
              },
              options: {
                responsive: true,
                plugins: { legend: { display: false } }
              }
            });
          });
    </script>

</th:block>
</html>
